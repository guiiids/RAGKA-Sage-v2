<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback Analytics Dashboard — Agilent Style</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --ag-blue: #0085d5;       
      --ag-dark-blue: #00426a;    
      --ag-med-blue: #2281c4;
      --ag-green: #3c7356;
      --ag-text: #202020;         
      --ag-text-2: #888b8d;       
      --ag-bg: #ffffff;           
      --ag-bg-2: #f4f3f1;         
      --ag-bg-3: #efefef;        
      --ag-border: #d0d0ce;
      --ag-radius: 12px;
      --container: 1240px;        
    }
    html, body { height: 100%; background: var(--ag-bg); color: var(--ag-text); font-family: 'Roboto', Arial, Helvetica, sans-serif; line-height: 1.45; }
    .container { max-width: var(--container); margin: 0 auto; padding: 0 12px; }
    .site-header { background: var(--ag-bg); border-bottom: 1px solid var(--ag-border); }
    .site-header .bar { height: 4px; background: var(--ag-blue); }
    .title-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; gap: 16px; }
    h1 { font-family: 'Roboto Condensed', Arial, Helvetica, sans-serif; font-size: 24px; letter-spacing: 0.2px; margin: 0; }
    .subtitle { color: var(--ag-text-2); font-size: 14px; margin-top: 4px; }
    .meta { display: flex; align-items: center; gap: 12px; color: var(--ag-text-2); font-size: 12px; white-space: nowrap; }
    .meta .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--ag-blue); display: inline-block; margin-right: 6px; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .btn { background: var(--ag-blue); color: #fff; border: 0; padding: 8px 12px; font-size: 12px; font-weight: 500; text-transform: uppercase; border-radius: 0;  cursor: pointer; }
    .btn.secondary { background: var(--ag-bg-3); color: var(--ag-text); }
    .btn.text { background: transparent; color: var(--ag-blue); }
    .input { height: 34px; padding: 0 8px; border: 1px solid var(--ag-border); width: 220px; max-width: 100%; font-size: 14px; border-radius: 0; background: #fff; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 1100px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .grid-4, .grid-2 { grid-template-columns: 1fr; } }
    .card { background: var(--ag-bg); border: 1px solid var(--ag-border); border-radius: var(--ag-radius); padding: 16px; }
    .card h2 { margin: 0 0 8px 0; font-size: 16px; }
    .kpi { display: flex; flex-direction: column; gap: 8px; }
    .kpi .label { color: var(--ag-text-2); font-size: 12px; }
    .kpi .value { font-family: 'Roboto Condensed', Arial, Helvetica, sans-serif; font-size: 28px; }
    .kpi .note { color: var(--ag-text-2); font-size: 11px; }
    .chart { height: 260px; }
    .section { margin: 20px 0; }
    .section-title { font-size: 16px; margin: 0 0 12px 0; padding-bottom: 8px; border-bottom: 1px solid var(--ag-border); }
    .table-wrap { overflow-x: auto; }
    table.data { border-collapse: collapse; width: 100%; table-layout: fixed; }
    table.data th { text-align: left; font-weight: 400; font-size: 12px; color: var(--ag-text-2); padding: 8px 16px 8px 0; border-bottom: 1px solid var(--ag-border); white-space: nowrap; text-transform: uppercase; letter-spacing: .2px; overflow: hidden; text-overflow: ellipsis; }
    table.data td { padding: 10px 16px 10px 0; font-size: 14px; vertical-align: top; color: var(--ag-text); border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    table.data tr:hover td { background: #fafafa; }
    .truncate { max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Column-specific widths for better viewport fit */
    #feedback-table th:nth-child(1), #feedback-table td:nth-child(1) { max-width: 105px; min-width: 80px; }
    #feedback-table th:nth-child(2), #feedback-table td:nth-child(2) { max-width: 220px; min-width: 120px; }
    #feedback-table th:nth-child(3), #feedback-table td:nth-child(3) { max-width: 240px; min-width: 120px; }
    #feedback-table th:nth-child(4), #feedback-table td:nth-child(4) { max-width: 140px; min-width: 95px; } /* STATUS wider */
    #feedback-table th:nth-child(5), #feedback-table td:nth-child(5) { max-width: 210px; min-width: 100px; } /* TAGS wider */
    #feedback-table th:nth-child(6), #feedback-table td:nth-child(6) { max-width: 260px; min-width: 120px; } /* COMMENTS wider */
    .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--ag-border); display: inline-block; }
    .badge.pos { color: var(--ag-green); border-color: rgba(60,115,86,.4); }
    .badge.neg { color: #9c2e2e; border-color: rgba(156,46,46,.35); }
    .badge.tag { color: var(--ag-text-2); }
    .footnote { color: var(--ag-text-2); font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="bar"></div>
    <div class="container">
      <div class="title-row">
        <div>
          <h1>Feedback Analytics Dashboard</h1>
          <div class="subtitle">Comprehensive analysis of user feedback data</div>
        </div>
        <div class="meta" id="generatedAt"><span class="dot"></span>Generated: —</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="section" style="display:flex; justify-content: space-between; align-items: center; gap:12px; flex-wrap: wrap;">
      <div class="controls">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn secondary" id="exportBtn">Export CSV</button>
        <button class="btn text" id="denseBtn">Dense mode</button>
      </div>
      <input class="input" id="search-input" placeholder="Search feedback…" />
    </div>

    <section class="section">
      <div class="grid-4">
        <div class="card kpi">
          <div class="label">Total Queries</div>
          <div class="value" id="kpi-total-queries">{{ total_queries }}</div>
          <div class="note">Unique user questions</div>
        </div>
        <div class="card kpi">
          <div class="label">Total Feedback</div>
          <div class="value" id="kpi-total-feedback">{{ total_feedback }}</div>
          <div class="note">All feedback entries</div>
        </div>
        <div class="card kpi">
          <div class="label">Positive Feedback</div>
          <div class="value" id="kpi-positive">{{ positive_feedback_pct|round(1) }}%</div>
          <div class="note"><span id="kpi-positive-detail">{{ positive_feedback_count }} of {{ total_feedback }}</span></div>
        </div>
        <div class="card kpi">
          <div class="label">Avg. Response Time</div>
          <div class="value" id="kpi-avg-time">{{ response_time.avg_response_time_seconds|round(1) }}s</div>
          <div class="note">
            Min {{ response_time.min_response_time_seconds|round(1) }}s ·
            Med {{ response_time.median_response_time_seconds|round(1) }}s ·
            Max {{ response_time.max_response_time_seconds|round(1) }}s
          </div>
        </div>
      </div>
    </section>

    <!-- Chart and word cloud sections will remain as-is with static/fake data for now -->

    <section class="section">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom: 8px;">
          <h2 class="section-title" style="border:0; padding:0; margin:0;">All Feedback</h2>
          <div class="subtitle">Total: <span id="total-count">{{ feedback_data | length }}</span> entries</div>
        </div>
        <div class="table-wrap">
          <table class="data" id="feedback-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User Query</th>
                <th>Response</th>
                <th>Status</th>
                <th>Tags</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="feedback-table-body">
              {% for row in feedback_data %}
                <tr>
                  <td class="truncate" title="{{ row.timestamp }}">{{ row.timestamp }}</td>
                  <td class="truncate" title="{{ row.user_query }}">{{ row.user_query }}</td>
                  <td class="truncate" title="{{ row.bot_response }}">{{ row.bot_response }}</td>
                  <td class="truncate">
                    {% set tags = row.feedback_tags %}
                    {% set status = "Negative" %}
                    {% set badge = "neg" %}
                    {% if tags %}
                      {% set positive_indicators = ["good", "accurate", "helpful", "clear", "looks good"] %}
                      {% for tag in tags %}
                        {% for indicator in positive_indicators %}
                          {% if indicator in tag|lower %}
                            {% set status = "Positive" %}
                            {% set badge = "pos" %}
                          {% endif %}
                        {% endfor %}
                      {% endfor %}
                    {% endif %}
                    <span class="badge {{ badge }}">{{ status }}</span>
                  </td>
                  <td class="truncate">
                    {% if not tags or tags|length == 0 %}
                      <span class="badge tag">No tags</span>
                    {% else %}
                      {% for tag in tags %}
                        {% set lower = tag|lower %}
                        {% if "good" in lower or "accurate" in lower or "helpful" in lower %}
                          <span class="badge pos">{{ tag }}</span>
                        {% elif "incorrect" in lower or "wrong" in lower %}
                          <span class="badge neg">{{ tag }}</span>
                        {% elif "unclear" in lower or "confusing" in lower or "incomplete" in lower %}
                          <span class="badge tag">{{ tag }}</span>
                        {% else %}
                          <span class="badge tag">{{ tag }}</span>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </td>
                  <td class="truncate" title="{{ row.comment }}">{{ row.comment }}</td>
                </tr>
              {% else %}
                <tr><td colspan="6" style="text-align:center;color:#888;">No feedback data available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="footnote">Typography, spacing, and color follow the Agilent website look-and-feel: Roboto / Roboto Condensed, #0085d5 primary, restrained accents, compact density.</div>
    <br />
  </main>
  <script>
    (function annotateTime(){
      const el = document.getElementById('generatedAt');
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const ts = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      el.innerHTML = `<span class="dot"></span>Generated: ${ts}`;
    })();

    document.getElementById('denseBtn').addEventListener('click', () => {
      document.body.classList.toggle('dense');
    });
    const denseStyles = document.createElement('style');
    denseStyles.innerHTML = `
      body.dense .card { padding: 12px; }
      body.dense .kpi .value { font-size: 24px; }
      body.dense table.data td { padding: 8px 12px 8px 0; }
    `;
    document.head.appendChild(denseStyles);

    const search = document.getElementById('search-input');
    const tbody = document.getElementById('feedback-table-body');
    const total = document.getElementById('total-count');

    function reCount(){ total.textContent = tbody.querySelectorAll('tr').length; }
    reCount();

    search.addEventListener('input', () => {
      const q = search.value.toLowerCase().trim();
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(r => {
        const t = r.textContent.toLowerCase();
        r.style.display = t.includes(q) ? '' : 'none';
      });
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const rows = [...document.querySelectorAll('#feedback-table tr')].map(tr => [...tr.children].map(td => '"'+td.textContent.replace(/"/g,'\"').trim()+'"').join(','));
      const blob = new Blob([rows.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'feedback_export.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Chart.js and Word Cloud JS will still use fake/static data as before for now

    document.getElementById('refreshBtn').addEventListener('click', () => {
      annotateTime && annotateTime();
    });
  </script>
</body>
</html>
